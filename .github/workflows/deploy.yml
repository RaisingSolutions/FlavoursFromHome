name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  backend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Test and Build Backend
      run: |
        cd backend
        npm ci
        npm run lint || echo "No lint script found"
        npm run test || echo "No test script found"
        npm run build

    - name: Deploy Backend
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # Setup SSH for git
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          eval $(ssh-agent -s)
          ssh-add ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          
          # Clone/update repository
          if [ -d "FlavoursFromHome" ]; then
            cd FlavoursFromHome
            git pull origin main
          else
            git clone git@github.com:RaisingSolutions/FlavoursFromHome.git
            cd FlavoursFromHome
          fi
          
          # Create backend environment file
          cat > backend/.env << EOF
          PORT=5000
          NODE_ENV=production
          CORS_ORIGIN=*
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          ORS_API_KEY=${{ secrets.ORS_API_KEY }}
          GREEN_API_INSTANCE_ID=${{ secrets.GREEN_API_INSTANCE_ID }}
          GREEN_API_TOKEN=${{ secrets.GREEN_API_TOKEN }}
          ADMIN_PHONE_NUMBER=${{ secrets.ADMIN_PHONE_NUMBER }}
          EOF
          
          # Stop and remove existing backend container
          sudo docker stop ffh-backend || true
          sudo docker rm ffh-backend || true
          
          # Build and start backend
          cd backend
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          sudo docker build -t ffh-backend:$TIMESTAMP .
          sudo docker tag ffh-backend:$TIMESTAMP ffh-backend:latest
          sudo docker run -d --name ffh-backend -p 5000:5000 --env-file .env --restart unless-stopped ffh-backend:latest
          
          # Debug: Check container status
          echo "=== Container Status ==="
          sudo docker ps -a | grep ffh-backend
          echo "=== Container Logs ==="
          sudo docker logs ffh-backend || true
          
          # Health check
          sleep 10
          curl -f http://localhost:5000/api/status || exit 1

  frontend:
    needs: backend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Test and Build Frontend
      run: |
        cd frontend
        npm install
        npm run lint || echo "No lint script found"
        npm run type-check || echo "No type-check script found"
        npm run build

    - name: Deploy Frontend
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd FlavoursFromHome
          
          # Create frontend environment file
          cat > frontend/.env << EOF
          VITE_API_BASE_URL=/api
          EOF
          
          # Stop and remove existing frontend container
          sudo docker stop ffh-frontend || true
          sudo docker rm ffh-frontend || true
          
          # Build and start frontend
          cd frontend
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          sudo docker build -t ffh-frontend:$TIMESTAMP .
          sudo docker tag ffh-frontend:$TIMESTAMP ffh-frontend:latest
          sudo docker run -d --name ffh-frontend -p 3000:80 --restart unless-stopped ffh-frontend:latest
          
          # Health check
          sleep 5
          curl -f http://localhost:3000 || exit 1

  admin:
    needs: frontend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Test and Build Admin
      run: |
        cd admin
        npm install
        npm run lint || echo "No lint script found"
        npm run build

    - name: Deploy Admin
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd FlavoursFromHome
          
          # Create admin environment file
          cat > admin/.env << EOF
          VITE_API_BASE_URL=/api
          EOF
          
          # Stop and remove existing admin container
          sudo docker stop ffh-admin || true
          sudo docker rm ffh-admin || true
          
          # Build and start admin
          cd admin
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          sudo docker build -t ffh-admin:$TIMESTAMP .
          sudo docker tag ffh-admin:$TIMESTAMP ffh-admin:latest
          sudo docker run -d --name ffh-admin -p 3001:80 --restart unless-stopped ffh-admin:latest
          
          # Setup Nginx reverse proxy with SSL
          cd ..
          sudo docker stop ffh-nginx || true
          sudo docker rm ffh-nginx || true
          sudo docker run -d --name ffh-nginx -p 80:80 -p 443:443 -v $(pwd)/nginx/nginx.conf:/etc/nginx/nginx.conf -v /etc/letsencrypt:/etc/letsencrypt:ro --link ffh-backend:backend --link ffh-frontend:frontend --link ffh-admin:admin --restart unless-stopped nginx:alpine
          
          # Health check
          sleep 5
          curl -f http://localhost:3001 || exit 1

  cleanup:
    needs: admin
    runs-on: ubuntu-latest
    
    steps:
    - name: Cleanup Old Images
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # Remove dangling images
          sudo docker image prune -f
          
          # Remove old tagged images (keep latest + 2 previous versions)
          sudo docker images ffh-backend --format "table {{.Repository}}:{{.Tag}}" | grep -v latest | tail -n +4 | xargs -r sudo docker rmi || true
          sudo docker images ffh-frontend --format "table {{.Repository}}:{{.Tag}}" | grep -v latest | tail -n +4 | xargs -r sudo docker rmi || true
          sudo docker images ffh-admin --format "table {{.Repository}}:{{.Tag}}" | grep -v latest | tail -n +4 | xargs -r sudo docker rmi || true
          
          # Remove unused volumes and networks
          sudo docker volume prune -f
          sudo docker network prune -f
          
          # Show deployment status
          echo "=== Deployment Complete ==="
          sudo docker ps
          echo "=== Available Services ==="
          echo "Frontend: http://35.177.125.164/"
          echo "Admin: http://35.177.125.164/admin/"
          echo "API: http://35.177.125.164/api/"